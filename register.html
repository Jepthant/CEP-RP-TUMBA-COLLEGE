<!DOCTYPE html>
<html lang="rw">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kwiyandikisha | CEP RP Tumba College</title>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <style>
        /* ==================== 0. THEME & BASE ==================== */
        :root{
            --bg:#f4f7fb;
            --card:#ffffff;
            --primary:#002147; 
            --accent:#1f6feb; 
            --gold:#ffd700;
            --muted:#667085;
            --success:#16a085;
            --danger:#e74c3c;
            --shadow-medium: 0 10px 30px rgba(0, 33, 71, 0.15);
        }
        * { box-sizing: border-box; }
        
        body {
            margin: 0; background-color: var(--bg); font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif; color: #0f1724;
            /* Shyira Logo muri Background */
            background-image: url('CEP-LOGO.png'); background-size: cover; background-position: center;
            background-attachment: fixed; background-blend-mode: luminosity; opacity: 0.9;
        }

        .wrap{
            min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px;
            background-color: rgba(255, 255, 255, 0.1); 
        }

        .card{
            width: 100%; max-width: 980px; background: var(--card); border-radius: 16px;
            box-shadow: var(--shadow-medium); overflow: hidden; display: flex; animation: fadeInDown 0.8s ease-out;
        }

        .left-side, .right-side{ padding: 40px; flex: 1; }
        .left-side{ background: rgba(255, 255, 255, 0.98); }
        .right-side{
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; background: var(--primary); color: #ffffff;
        }
        .right-side h2 { color: var(--gold); }
        .right-side img { width: 120px; margin-bottom: 20px; }

        /* --- FORM ELEMENTS & RESPONSIVENESS --- */
        h1{color:var(--primary); font-weight: 800; margin-bottom: 20px;}
        
        .name-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group{margin-bottom:18px; text-align:left;}
        .input-group label{display:block; margin-bottom:5px; font-size:0.9rem; font-weight:600;}
        .input-group input, .input-group select{
            width:100%; padding:12px; border:1px solid #d0d7de; border-radius:8px; font-size:1rem;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: var(--accent); box-shadow: 0 0 0 2px rgba(31, 111, 235, 0.2); outline: none;
        }

        .btn-primary{
            display:block; width:100%; padding:14px 15px; border-radius:10px; font-weight:700;
            cursor:pointer; margin-top:25px; background:var(--accent); color:#ffffff; border:none;
            transition: all 0.25s;
        }
        .btn-primary:hover{ background: #1a5edb; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(31, 111, 235, 0.3); }
        .btn-primary:disabled { background: #a9c7f7; cursor: not-allowed; transform: none; box-shadow: none; }

        /* MESSAGES */
        .error-message, .success-message {
            padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; text-align: center; display: none;
        }
        .error-message { background-color: #fcebeb; color: var(--danger); }
        .success-message { background-color: #e6f7ef; color: var(--success); border: 1px solid var(--success); }

        /* MEDIA QUERIES (MOBILE) */
        @media (max-width: 980px) {
            .card{ flex-direction: column; max-width: 600px; }
            .left-side, .right-side{ padding: 30px; min-width: auto; }
            .right-side { display: none; } /* Guha umwanya form kuri mobile */
            .name-group { grid-template-columns: 1fr; gap: 0; }
        }
    </style>
</head>
<body>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // SHYIRAMO URL NA KEY YAWE NYAYO HANO
        const SUPABASE_URL = "https://snasuickudieijxxwonw.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuYXN1aWNrdWRpZWlqeHh3b253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDY5OTMsImV4cCI6MjA3NDkyMjk5M30.i58HzvLSVO_2_675U38iaxrBQPzdtPOS0yI0HbZcof4"; 
        
        // Kora Supabase Client
        window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: false, detectSessionInUrl: false }
        });
        const supabase = window.supabase;
        
        // Helper functions
        function showMessage(type, message) {
            const errorDiv = document.getElementById('error-msg-reg');
            const successDiv = document.getElementById('success-msg-reg');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            const msgDiv = type === 'error' ? errorDiv : successDiv;
            msgDiv.innerHTML = message;
            msgDiv.style.display = 'block';
            setTimeout(() => { msgDiv.style.display = 'none'; }, 10000); 
        }
        const showError = (message) => showMessage('error', message);
        const showSuccess = (message) => showMessage('success', message);

        // REGISTER HANDLER - Koresha 'submit' event ya Form
        const registerForm = document.getElementById('register-form');
        const submitBtn = document.getElementById('submit-button');

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 

            // Hindura Butoni
            submitBtn.disabled = true; 
            submitBtn.textContent = 'Birimo Kwiyandikisha...';
            
            // Fata amakuru muri form
            const firstName = document.getElementById('first_name').value.trim(); 
            const lastName = document.getElementById('last_name').value.trim(); 
            const email = document.getElementById('email_register').value.trim(); 
            const password = document.getElementById('password_register').value;
            const family = document.getElementById('family').value;
            const phone = document.getElementById('phone').value.trim();
            const leaderPhone = document.getElementById('leader_phone').value.trim(); 
            const churchParish = document.getElementById('church_parish').value.trim(); 

            // Kwemeza ko amakuru yose ahari
            if (!firstName || !lastName || !email || !password || !family || !phone || !leaderPhone || !churchParish) {
                showError('Uzuza ahantu hose hasabwa.');
                submitBtn.disabled = false; 
                submitBtn.textContent = 'Kwiyandikisha';
                return;
            }

            try {
                // Step 1: Supabase Sign Up - Gukora konti no kohereza Email Confirmation
                // Turi gushyira amakuru muri 'data' kugira ngo Trigger ibashe kuyabona (Ibi bikeneye Trigger Yihariye)
                const { error: signUpError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            first_name: firstName,
                            last_name: lastName,
                            family_name: family, 
                            phone_number: phone, 
                            church_leader_phone: leaderPhone,
                            church_parish: churchParish, 
                        }
                    }
                });

                if (signUpError) {
                    let errorMessage = 'Kwiyandikisha byanze: ';
                    if (signUpError.message.includes('Password should be at least 6 characters')) {
                        errorMessage = 'Password igomba kugira inyuguti zirenga 6.';
                    } else if (signUpError.message.includes('User already registered')) {
                        errorMessage = 'Email yaranditswe. Injira cyangwa ukoreshe email nshya.';
                    } else {
                        // Kubera ko turi gukora Email Confirmation, nta 'Database error saving new user' igomba kubaho hano
                        errorMessage += signUpError.message;
                    }
                    showError(errorMessage);
                    return;
                }
                
                // Step 2: Confirmation Message Gusa
                showSuccess(`Urakoze kwiyandikisha! Kugira ngo ukomeze, **genzura inbox ya Email** yawe (cyangwa Spam folder) maze wemeze konti yawe.`);

            } catch (err) {
                console.error("Ibibazo muri Network cyangwa Supabase Client:", err);
                showError('Habaye ikibazo gikomeye: Genzura connection ya internet cyangwa Supabase Keys.');
            } finally {
                // Gusubiza Butoni uko yari imeze
                submitBtn.disabled = false; 
                submitBtn.textContent = 'Kwiyandikisha';
            }
        });

    </script>

    <div class="wrap">
        <div class="card">
            <div class="left-side">
                <h1 class="title">Kwiyandikisha Gushya</h1>
                <p id="error-msg-reg" class="error-message"></p>
                <p id="success-msg-reg" class="success-message"></p>
                
                <form class="register-form" id="register-form">
                    
                    <div class="name-group">
                        <div class="input-group">
                            <label for="first_name">Izina rya mbere (First Name):</label>
                            <input type="text" id="first_name" required placeholder="Izina ryawe">
                        </div>
                        <div class="input-group">
                            <label for="last_name">Izina rya nyuma (Last Name):</label>
                            <input type="text" id="last_name" required placeholder="Izina ry'Umuryango">
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="email_register">Email:</label>
                        <input type="email" id="email_register" required placeholder="name@example.com">
                    </div>
                    <div class="input-group">
                        <label for="password_register">Password:</label>
                        <input type="password" id="password_register" required placeholder="Shyiramo password ikomeye (6+ characters)">
                    </div>
                    
                    <div class="input-group">
                        <label for="phone">Numero ya Telefone (Iyawe):</label>
                        <input type="tel" id="phone" name="phone" required placeholder="07XXXXXXXX">
                    </div>
                    
                    <div class="input-group">
                        <label for="church_parish">Aho Wasengeraga / Paruwasi:</label>
                        <input type="text" id="church_parish" name="church_parish" required placeholder="Ruhango Parish / ADEPR Nyamirambo">
                    </div>
                    
                    <div class="input-group">
                        <label for="leader_phone">Numero y'Umukuru w'Itorero wasengeragaho:</label>
                        <input type="tel" id="leader_phone" name="leader_phone" required placeholder="07XXXXXXXX">
                    </div>

                    <div class="input-group">
                        <label for="family">Hitamo Family yawe:</label>
                        <select id="family" name="family" required>
                            <option value="" disabled selected>-- Hitamo Family --</option>
                            <option value="Yakin">Yakin</option>
                            <option value="Ebenezer">Ebenezer</option>
                            <option value="Ishilo">Ishilo</option>
                            <option value="Il'estviva">Il'estviva</option>
                            <option value="Enhachole">Enhachole</option>
                            <option value="None">ntabwo ndahabwa Family</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-primary" id="submit-button">Kwiyandikisha</button>
                </form>
                
                <p style="margin-top:20px; font-size:0.9rem; color:var(--muted);">Wamaze kugira Konti? <a href="login.html" style="color:var(--primary); font-weight:700;">Injira Hano</a></p>
            </div>


            <div class="right-side">
                <img src="CEP-LOGO.png" alt="CEP Logo">
                <h2>Murakaza Neza muri CEP RP Tumba!</h2>
                <p>Urakoze! Reba Email yawe wemeze konti. Ibi biguha uburenganzira bwuzuye bw'umunyamuryango.</p>
                <div style="margin-top:30px; font-size:1.5rem; color:var(--gold);">
                    <i class="fas fa-check-circle" style="margin: 0 10px;"></i>
                    <i class="fas fa-envelope-open-text" style="margin: 0 10px;"></i>
                    <i class="fas fa-lock-open" style="margin: 0 10px;"></i>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
